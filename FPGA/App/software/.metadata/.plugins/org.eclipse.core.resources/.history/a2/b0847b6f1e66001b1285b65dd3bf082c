#pragma once

#include <stdint.h>

/**
 * 共有メモリーの構造を定義する構造体 (最大1024バイト)
 */
struct SharedMemory_t {
    /**
     * エラーフラグのビットマップ
     * エラー発生後にこの値を0にクリアするとエラーが解除される
     */
    uint32_t ErrorFlags;

    /**
     * フォルトフラグのビットマップ
     */
    uint32_t FaultFlags;

    /**
     * 前方のチェックサム
     * HeadChecksumとTailChecksumが等しいときにのみParametersは有効として扱われる
     */
    uint32_t HeadChecksum;

    /**
     * JetsonからNios IIへ制御パラメータを伝達する構造体
     */
    struct Parameters_t {
        /**
         * 車輪1の速度[m/s]
         */
        float Wheel1Speed;

        /**
         * 車輪2の速度[m/s]
         */
        float Wheel2Speed;

        /**
         * 車輪3の速度[m/s]
         */
        float Wheel3Speed;

        /**
         * 車輪4の速度[m/s]
         */
        float Wheel4Speed;

        /**
         * ドリブルパワー (-1.0 ～ 1.0)
         */
        float DribblePower;

        /**
         * チェックサムを計算する
         * この関数はParameters_tが4の倍数バイトの大きさであることを前提にしている
         */
        uint32_t CalculateChecksum(void) const {
            auto p = reinterpret_cast<const uint32_t*>(this);
            int count = sizeof(Parameters_t) / sizeof(uint32_t);
            uint32_t result = 0xA5A5A5A5;
            while (0 <= --count) {
                result += *p++;
            }
            return result;
        }
    } Parameters;

    /**
     * 後方のチェックサム
     * HeadChecksumとTailChecksumが等しいときにのみParametersは有効として扱われる
     */
    uint32_t TailChecksum;
};
